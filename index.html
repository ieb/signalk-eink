<!DOCTYPE html>
<html>
<head>
    <title>eInk Data</title>
    <!-- 
    Kindle Experimental Browser is a old version of WebKit, with no 
    websockets or JSON support, very limited css, no console.log, and a significant number
    of quirks. Its probably not ES5 compliant, and a test with react produced a non functional
    hello world. It does hoave have Canvas Support which is what this UI uses.

    Typiclly, this SPA remains open all the time on the Kindle and maintains its
    state in the SPA. Dont expect it to maintain state when navigating away.

    Dont expect rapid updates, eink was not designed to perform animation, but a 1s update for 
    a clock in Canvas does work.
-->
</head>
<body>
<canvas id="canvas" width="580" height="690" style="background-color:#FFF"></canvas>
<textarea id="debug"></textarea>
<script>
var debug = document.getElementById("debug");
var console = console || {};
console.log = console.log || function(a) {
    debug.value = debug.value+a+"\n";
}


XMLHttpRequest.UNSENT = XMLHttpRequest.UNSENT || 0;
XMLHttpRequest.OPENED = XMLHttpRequest.OPENED || 1;
XMLHttpRequest.HEADERS_RECEIVED = XMLHttpRequest.HEADERS_RECEIVED || 2;
XMLHttpRequest.LOADING = XMLHttpRequest.LOADING || 3;
XMLHttpRequest.DONE = XMLHttpRequest.DONE || 4;


var dataStreamUrl = '/signalk/v1/api/einknmea'
var nmeaStream = function(httpRequest) {
    if (httpRequest.readyState === XMLHttpRequest.DONE) {
      if (httpRequest.status === 200) {
        var sentences = httpRequest.responseText.split("\n");
        for (var i = 0; i < sentences.length; i++) {
            processSentence(sentences[i]);
        };
      }
    }
}
var lastDataSet = false;
function fetchData() {
    var httpRequest = new XMLHttpRequest();
    httpRequest.onreadystatechange = function() {
        nmeaStream(httpRequest);
    };
    httpRequest.open('GET', dataStreamUrl);
    if (lastDataSet) {
        httpRequest.setRequestHeader("x-since",lastDataSet);
    }
    lastDataSet = new Date().getTime();
    httpRequest.send();
};
fetchData();
setInterval(fetchData, 5000);



var canvas = document.getElementById("canvas");
var ctx = canvas.getContext("2d");

ctx.rotate(-Math.PI/2);
ctx.translate(-690,20);

function textBox(text,sz, labels) {
  ctx.font =  sz+"px arial";
  ctx.textBaseline="bottom";
  ctx.textAlign="center";
  var w = sz*2.2, h= sz*1.2;
  ctx.beginPath();
  ctx.fillStyle = 'white';
  ctx.fillRect(0,0,w,h);
  ctx.strokeRect(0,0,w,h);
  ctx.fillStyle = 'black';
  ctx.fillText(text, w*0.5,h);
  if ( labels ) {
    ctx.font =  (sz/4)+"px arial";
    ctx.textAlign="left";
    if ( labels.tl ) {
        ctx.fillText(labels.tl, w*0.05,sz/4);
    }
    if ( labels.bl ) {
        ctx.fillText(labels.bl, w*0.05,h);
    }
    ctx.textAlign="right";
    if ( labels.tr ) {
        ctx.fillText(labels.tr, w*0.95,sz/4);
    }
    if ( labels.br ) {
        ctx.fillText(labels.br, w*0.95,h);
    }
  }
}

function processSentence(sentence) {
    var record = sentence.substring(3,6);
    if  (nmea[record]) {
        var box = nmea[record];
        var t = box.y*1.3*box.boxSize, l = box.x*2.3*box.boxSize
        ctx.translate(l,t);
        textBox(nmea[record].format(sentence.split(",")),box.boxSize,box.labels);
        ctx.translate(-l,-t);
    }
}


var nmea = {
    'DBT': {
        boxSize: 100,
        x: 0,
        y: 0,
        labels: {
            bl: "dbt",
            br: "m"
        },
        format: function(values) {
            return +values[3];
        }
    }
}



//update("$GPDBT,0017.6,f,0005.4,M");

/*
var v = 0;
var boxSize = 100;
function refresh() {
    for (var i = 0; i < 4; i++) {
        for (var j = 0; j < 3; j++) {
            var t = i*1.3*boxSize, l = j*2.3*boxSize
            ctx.translate(l,t);
            textBox(""+v,boxSize, {
                tl: "tlt",
                bl: "blt",
                tr: "trt",
                br: "brt",
            });
            ctx.translate(-l,-t);
            v = (v + 1)%1000;
        }
    }
}
*/


</script>
</body>
</html>