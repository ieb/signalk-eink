<!DOCTYPE html>
<html>
<head>
    <title>eInk Data</title>
    <!-- 
    Kindle Experimental Browser is a old version of WebKit, with no 
    websockets or JSON support, very limited css, no console.log, and a significant number
    of quirks. Its probably not ES5 compliant, and a test with react produced a non functional
    hello world. It does hoave have Canvas Support which is what this UI uses.

    Typiclly, this SPA remains open all the time on the Kindle and maintains its
    state in the SPA. Dont expect it to maintain state when navigating away.

    Dont expect rapid updates, eink was not designed to perform animation, but a 1s update for 
    a clock in Canvas does work.
-->
</head>
<body>
<canvas id="canvas" width="580" height="690" style="background-color:#FFF"></canvas>
<textarea id="debug"></textarea>
<script>
var debugEl = document.getElementById("debug");
var console = console || {};
var debug = function(a) {
    debugEl.value = debugEl.value+JSON.stringify(a)+"\n";
}
console.log = console.log || debug;

function Updater(options) {
    this.url = options.url;
    this.period = options.per
    this.context = options.context;
    XMLHttpRequest.UNSENT = XMLHttpRequest.UNSENT || 0;
    XMLHttpRequest.OPENED = XMLHttpRequest.OPENED || 1;
    XMLHttpRequest.HEADERS_RECEIVED = XMLHttpRequest.HEADERS_RECEIVED || 2;
    XMLHttpRequest.LOADING = XMLHttpRequest.LOADING || 3;
    XMLHttpRequest.DONE = XMLHttpRequest.DONE || 4;

    if ( this.period ) {
        var that = this;
        setInterval(function() {
            that.update();
        }, this.period);        
    }
}

Updater.prototype.update = function() {
    var that = this;
    var httpRequest = new XMLHttpRequest();
    httpRequest.onreadystatechange = function() {
        if (httpRequest.readyState === XMLHttpRequest.DONE) {
          if (httpRequest.status === 200) {
            var state = JSON.parse(httpRequest.responseText);
            that.context.update(state);
          }
        }
    };
    httpRequest.open('GET', this.url);
    httpRequest.send();
};




function DrawingContext(options) {
    this.canvas = options.canvas;
    this.displayList = options.displayList;
    this.ctx = canvas.getContext("2d");
    this.ctx.rotate(-Math.PI/2);
    this.ctx.translate(-690,20);
}

DrawingContext.prototype.update = function(state) {
    for (var i = 0; i < this.displayList.length; i++) {
        this.displayList[i].render(this.ctx, state);
    };
};






function TextBox(options) {
    this.path = options.path;
    this.pathElements = options.path.split(".");
    this.boxSize = options.boxSize || 100;
    this.labels = options.labels || {};
    this.format = options.format || function(d) { return d.value };
    this.x = options.x || 0;
    this.y = options.y || 0;
    this.lastText = undefined;

}

TextBox.prototype.resolve = function(state) {
    var n = state;
    for (var i = 0; n && i < this.pathElements.length; i++) {
        n = n[this.pathElements[i]];
    }
    console.log("Resoved "+this.path+" as "+n)
    return n;
}

TextBox.prototype.render = function(ctx, state) {
  var d = this.resolve(state);
  if (!d) {
    return;
  }
  var text = this.format(d);
  if ( text === this.lastText ) {
    return;
  }
  this.lastText = text;
  var sz = this.boxSize;
  var labels = this.labels;
  var t = this.y*1.3*sz, l = this.x*2.3*sz,  w = sz*2.2, h= sz*1.2;
  ctx.translate(l,t); 
  ctx.font =  sz+"px arial";
  ctx.textBaseline="bottom";
  ctx.textAlign="center";
  ctx.beginPath();
  ctx.fillStyle = 'white';
  ctx.fillRect(0,0,w,h);
  ctx.strokeRect(0,0,w,h);
  ctx.fillStyle = 'black';
  ctx.fillText(text, w*0.5,h);
  if ( labels ) {
    ctx.font =  (sz/4)+"px arial";
    ctx.textAlign="left";
    if ( labels.tl ) {
        ctx.fillText(labels.tl, w*0.05,sz/4);
    }
    if ( labels.bl ) {
        ctx.fillText(labels.bl, w*0.05,h);
    }
    ctx.textAlign="right";
    if ( labels.tr ) {
        ctx.fillText(labels.tr, w*0.95,sz/4);
    }
    if ( labels.br ) {
        ctx.fillText(labels.br, w*0.95,h);
    }
  }
  ctx.translate(-l,-t);
}



var display = [
    new TextBox({ 
        path: 'environment.wind.angleApparent',
        x: 0,
        y: 0,
        labels: {
            bl: "awa",
            br: "deg"
        },
        format: function(o) {
            return Math.round(o.value*180/Math.PI)
        }
    })
];

var drawingContext = new DrawingContext({
    canvas: document.getElementById("canvas"),
    displayList: display
});


var updater =  new Updater({
    url: '/signalk/v1/api/vessels/self',
    context: drawingContext
});
updater.update();






</script>
</body>
</html>